<html>
    <head> 
        <title>ElecStat</title>
        
        <!--Scripts be here-->
        <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
        <script type="application/javascript" src="script/jquery-ui.min.js"></script>
        <script type="application/javascript" src="script/crossfilter.min.js"></script>
        
        <script type="application/javascript" src="script/script.js"></script>
        <script type="application/javascript" src="script/jQAllRangeSliders-min.js"></script>
        <script type="application/javascript" src="script/Misc.js"></script>
        
        <!--Stylesheets-->
        <link rel="stylesheet" href="style/style.css"></link>
        <link rel="stylesheet" href="style/iThing-min.css"></link>

    </head>
    
    


    <style> /* set the CSS */

body { font: 12px Arial;}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

</style>
<body>
    <script>
        //Basic init
        var w=window.innerWidth; var h=window.innerHeight;
        var svgWidth = w/2.09, svgHeight = h/1.3;
        var svg = d3.select('body').attr("width",w).attr("height",h);
        var startYear = 1, endYear = 5, startMonth = "Jan",endMonth = "Feb",state="United States",filter="Nuclear",Globaldata=[];
        
        //Title
        svg.append('p').attr('id','ElectStat-title').text("ElectStat");
        
        //Choropleth map
        var map = svg.append('svg').attr('id','choro-map').attr('class','svgclass').attr("width",svgWidth).attr('height',svgHeight).append('g');
        d3.xml("Blank_US_Map.svg", "image/svg+xml", function(xml){
            $('#choro-map g').append(xml.documentElement);
            d3.select('#blank_map').attr("viewBox", "10 30 920 500");
        });
        map.selectAll(".palette")
    .data(d3.entries(colorbrewer))
  .enter().append("span")
    .attr("class", "palette")
    .attr("title", function(d) { return d.key; })
    .on("click", function(d) { console.log(d3.values(d.value).map(JSON.stringify).join("\n")); })
  .selectAll(".swatch")
    .data(function(d) { return d.value[d3.keys(d.value).map(Number).sort(d3.descending)[0]]; })
  .enter().append("span")
    .attr("class", "swatch")
    .style("background-color", function(d) { return d; });
        
        
        
        
        
        //Line graph
      // Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = svgWidth - margin.left - margin.right,
    height = svgHeight - margin.top - margin.bottom;

    
// Adds the svg canvas
var svg = d3.select("body")
    .append("svg")
        .attr('id','line-graph').attr('class','svgclass')
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");
        
        
        function lineGraph(data){
               var dataGroup = d3.nest()
                        .key(function(d) {return d.source;})
                        .entries(data);
                    console.log(dataGroup);
                    //console.log(JSON.stringify(dataGroup));
                    var color = d3.scale.category10();
                    var vis = d3.select("#line-graph"),
                        WIDTH = 1000,
                        HEIGHT = 500,
                        MARGINS = {
                            top: 50,
                            right: 20,
                            bottom: 50,
                            left: 50
                        },
                        lSpace = WIDTH/dataGroup.length;
                        xScale = d3.time.scale().range([MARGINS.left, WIDTH - MARGINS.right]).domain([d3.min(data, function(d) {
                            return d.date;
                        }), d3.max(data, function(d) {
                            return d.date;
                        })]),
                        yScale = d3.scale.linear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([d3.min(data, function(d) {
                            return d.amount;
                        }), d3.max(data, function(d) {
                            return d.amount;
                        })]),
                        xAxis = d3.svg.axis()
                        .scale(xScale),
                        yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient("left").tick(5);
                    
                    vis.append("svg:g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
                        .call(xAxis);
                    vis.append("svg:g")
                        .attr("class", "y axis")
                        .attr("transform", "translate(" + (MARGINS.left) + ",0)")
                        .call(yAxis);
                        
                    var lineGen = d3.svg.line()
                        .x(function(d) {
                            return xScale(d.date);
                        })
                        .y(function(d) {
                            return yScale(d.amount);
                        })
                        .interpolate("basis");
                    dataGroup.forEach(function(d,i) {
                        vis.append('svg:path')
                        .attr('d', lineGen(d.values))
                        .attr('stroke', function(d,j) { 
                                return "hsl(" + Math.random() * 360 + ",100%,50%)";
                        })
                        .attr('stroke-width', 2)
                        .attr('id', 'line_'+d.key)
                        .attr('fill', 'none');
                        vis.append("text")
                            .attr("x", (lSpace/2)+i*lSpace)
                            .attr("y", HEIGHT)
                            .style("fill", "black")
                            .attr("class","legend")
                            .on('click',function(){
                                var active   = d.active ? false : true;
                                var opacity = active ? 0 : 1;
                                d3.select("#line_" + d.key).style("opacity", opacity);
                                d.active = active;
                            })
                            .text(d.key);
                    });
                    
                }

        
        
        

     var parseDate = d3.time.format("%y-%b").parse;
     function drawline(checkedValues,dataSet)
        {
            var data=[],i=0;
            for(var sourceValue in checkedValues){
             var datafil= datafilter(dataSet,state,checkedValues[sourceValue],startYear,endYear,startMonth,endMonth);
            for(var value in datafil){
                if(value != 'state'){
                var obj={};
                    obj['source'] = checkedValues[sourceValue];
                obj['date'] = parseDate(value);
                obj['amount'] = datafil[value];
                data.push(obj);
                    i++;
                }
            }
            }
            return data;
        
     }
     
     
     
     
    
     
        
        //Controls
       // var controls = svg.append('svg').attr('id','controls').attr('class','svgclass').attr('width','100%').attr('height','100%').append('g');
        //Doc ready
       $(document).ready(function() {

          $("#YearSlider").rangeSlider({bounds: {min: 2001, max: 2015}},{defaultValues:{min: 2005, max: 2010}});
          $("#MonthSlider").rangeSlider(
              {bounds: {min: 0, max: 11}},
              {defaultValues:{min: 2, max: 5}},
              {formatter:function(val){
                  var value = Math.round(val);
                  return months[value];
                  console.log(value);
              }}
          );
           
        $("#YearSlider").bind("valuesChanging", function(e, data){
            startYear = (Math.round(data.values.min))-2000;
            endYear = (Math.round(data.values.max))-2000;
            render();
        });   
           
           $("#MonthSlider").bind("valuesChanging", function(e, data){
               startMonth = months[Math.round(data.values.min)];
               endMonth = months[Math.round(data.values.max)];
               
            render();
        }); 
            $('.Source-checklist').change(function(){ 
                    render();
         });
           
       
                
       
        
        //Crossfilter
 //$('.Source-checklist').change(function(){ console.log('checkl'); });
        function render(){
         d3.csv("Dataset-formatted.csv" , function(error, data){
             
             var checkedValues = $('input:checkbox:checked.Source-checklist').map(function () {
                return this.value;
            }).get();
             Globaldata = data;
             var datafil = [],test=[];;
           
             //console.log(datafil);
           //  console.log(statesCode[statesInData[state]]);
            mapData(data,state,checkedValues,startYear,endYear,startMonth,endMonth);
            lineGraph(drawline(checkedValues,data));
         }); 
        }
        render();
         
        }); //Doc end
    </script>
    <div>
        <form>
            <input class ="Source-checklist" type="checkbox" name="GenTypes" value="Nuclear" /><label>Nuclear</label>
            <input class ="Source-checklist" type="checkbox" name="GenTypes" value="Solar" /><label>Solar</label>
            <input class ="Source-checklist" type="checkbox" name="GenTypes" value="Wind" checked/><label>Wind</label>
            <input class ="Source-checklist" type="checkbox" name="GenTypes" value="Geothermal" /><label>Geothermal</label>
            <input class ="Source-checklist" type="checkbox" name="GenTypes" value="Coal" /><label>Coal</label>
        </form>
    </div>
    <div id="YearSlider"></div>
    <div id="MonthSlider"></div>
</body>
</html>