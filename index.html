<html>
    <head> 
        <title>ElecStat</title>
        
        <!--Scripts be here-->
        <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
        <script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
        <script type="application/javascript" src="script/jquery-ui.min.js"></script>
        <script type="application/javascript" src="script/crossfilter.min.js"></script>
        
        <script type="application/javascript" src="script/script.js"></script>
        <script type="application/javascript" src="script/jQAllRangeSliders-min.js"></script>
        <script type="application/javascript" src="script/Misc.js"></script>
        
        <!--Stylesheets-->
        <link rel="stylesheet" href="style/style.css"></link>
        <link rel="stylesheet" href="style/iThing-min.css"></link>





    </head>
    
    <style> /* set the CSS */

body { font: 12px Arial;}

path { 
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

</style>
<body>
    <script>
        //Basic init
        var w=window.innerWidth; var h=window.innerHeight;
        var svgWidth = w/2.09, svgHeight = h/1.3;
        var svg = d3.select('body').attr("width",w).attr("height",h);
        
        //Title
        svg.append('p').attr('id','ElectStat-title').text("ElectStat");
        
        //Choropleth map
        var map = svg.append('svg').attr('id','choro-map').attr('class','svgclass').attr("width",svgWidth).attr('height',svgHeight).append('g');
        d3.xml("Blank_US_Map.svg", "image/svg+xml", function(xml){
            $('#choro-map g').append(xml.documentElement);
            d3.select('#blank_map').attr("viewBox", "10 30 920 500");
        });
        map.selectAll(".palette")
    .data(d3.entries(colorbrewer))
  .enter().append("span")
    .attr("class", "palette")
    .attr("title", function(d) { return d.key; })
    .on("click", function(d) { console.log(d3.values(d.value).map(JSON.stringify).join("\n")); })
  .selectAll(".swatch")
    .data(function(d) { return d.value[d3.keys(d.value).map(Number).sort(d3.descending)[0]]; })
  .enter().append("span")
    .attr("class", "swatch")
    .style("background-color", function(d) { return d; });
       
        
        
        
        
        
        
        
        //Line graph
       // var lineGraph = svg.append('svg').attr('id','line-graph').attr('class','svgclass').attr("width",svgWidth).attr('height',svgHeight).append('g');
        
        
// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = svgWidth - margin.left - margin.right,
    height = svgHeight - margin.top - margin.bottom;

// Parse the date / time
var parseDate = d3.time.format("%b %Y").parse; 

// Set the ranges
var x = d3.time.scale().range([0, width]);
var y = d3.scale.linear().range([height, 0]);

// Define the axes
var xAxis = d3.svg.axis().scale(x)
    .orient("bottom").ticks(5);

var yAxis = d3.svg.axis().scale(y)
    .orient("left").ticks(5);

// Define the line
var priceline = d3.svg.line()
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.price); });
    
// Adds the svg canvas
var svg = d3.select("body")
    .append("svg")
        .attr('id','line-graph').attr('class','svgclass')
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");

// Get the data
    var inputfile =   "data.csv";
 var graphdata = d3.csv(inputfile, function(error, data) {
    data.forEach(function(d) {
		d.date = parseDate(d.date);
		d.price = +d.price;
    });

    // Scale the range of the data
    x.domain(d3.extent(data, function(d) { return d.date; }));
    y.domain([0, d3.max(data, function(d) { return d.price; })]); 

    // Nest the entries by symbol
    var dataNest = d3.nest()
        .key(function(d) {return d.symbol;})
        .entries(data);

    // Loop through each symbol / key
    dataNest.forEach(function(d) {

        svg.append("path")
            .attr("class", "line")
            .attr("d", priceline(d.values)); 

    });

    // Add the X Axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

});
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        //Controls
       // var controls = svg.append('svg').attr('id','controls').attr('class','svgclass').attr('width','100%').attr('height','100%').append('g');
        //Doc ready
       $(document).ready(function() {
          $("#YearSlider").rangeSlider({bounds: {min: 2001, max: 2015}},{defaultValues:{min: 2005, max: 2010}});
          $("#MonthSlider").rangeSlider(
              {bounds: {min: 0, max: 11}},
              {defaultValues:{min: 2, max: 5}},
              {formatter:function(val){
                  var value = Math.round(val);
                  return months[value];
                  console.log(value);
              }}
          );
       });
        //Doc end
        
        //Crossfilter
        
         d3.csv("Dataset-formatted.csv" , function(error, data){
            // console.log(data);
             var startYear = 1, endYear = 2, startMonth = "Jan",endMonth = "Dec",state="United States",filter="Coal";
             var datafil = [];
            datafil= datafilter(data,state,filter,startYear,endYear,startMonth,endMonth);
             console.log(datafil);
             var datesRequested = [];
             datesRequested = generateStateFormat(startYear,endYear,startMonth,endMonth);
             
             var statesInData =[];
             for(var state in data){
                statesInData.push(data[state]['state']);
             }
            statesInData = unique(statesInData);
            var choroData = [];
             var total=0;
             for(var state in statesInData){
                  datafil= datafilter(data,statesInData[state],filter,startYear,endYear,startMonth,endMonth);
             for(var value in datafil){
                  if(isInArray(value,datesRequested))
                    total += parseInt(datafil[value]);
                    }
                 choroData[statesInData[state]] = total;
                 total = 0;
              }
             console.log(choroData);

         }); 
        
        
    </script>
    <div id ="Source-checklist">
        <div>
            <input type="checkbox" name="GenTypes" value="Nuclear" /><label>Nuclear</label>
            <input type="checkbox" name="GenTypes" value="Solar" /><label>Solar</label>
            <input type="checkbox" name="GenTypes" value="Wind" /><label>Wind</label>
            <input type="checkbox" name="GenTypes" value="Thermal" /><label>Thermal</label>
        </div>
    </div>
    <div id="YearSlider"></div>
    <div id="MonthSlider"></div>
</body>
</html>